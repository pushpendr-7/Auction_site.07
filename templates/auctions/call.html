{% extends 'auctions/base.html' %}
{% block title %}Call - {{ item.title }}{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Live Call: {{ item.title }}</h1>
<div class="row g-3">
  <div class="col-md-8">
    <div class="ratio ratio-16x9 bg-black border border-1">
      <div id="jitsiContainer" class="w-100 h-100"></div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <p class="small text-muted">Connected to video room. Participants join muted; seller can publish video.</p>
        <div class="d-flex gap-2"><a href="/items/{{ item.pk }}/" class="btn btn-outline-secondary btn-sm">Back to Item</a></div>
      </div>
    </div>
  </div>
</div>
<script src="https://meet.jit.si/external_api.js"></script>
<script>
(function(){
  var domain = 'meet.jit.si';
  var roomName = 'auction-item-{{ item.pk }}';
  var userName = "{{ user.username|default:'Guest'|escapejs }}";
  var isOwner = {% if is_owner %}true{% else %}false{% endif %};

  var options = {
    roomName: roomName,
    parentNode: document.getElementById('jitsiContainer'),
    width: '100%',
    height: '100%',
    userInfo: { displayName: userName },
    configOverwrite: {
      prejoinConfig: { enabled: false },
      startWithAudioMuted: !isOwner,
      startWithVideoMuted: !isOwner
    }
  };

  try {
    // eslint-disable-next-line no-undef
    var api = new JitsiMeetExternalAPI(domain, options);
    if (!isOwner) {
      api.executeCommand('toggleAudio');
      api.executeCommand('toggleVideo');
    }
  } catch (err) {
    console.error('Failed to load video room', err);
    var c = document.getElementById('jitsiContainer');
    if (c) c.innerHTML = '<div class="text-center text-muted p-3">Unable to start video. Please check your network and try again.</div>';
  }
})();
</script>
{% endblock %}
