{% extends 'auctions/base.html' %}
{% block title %}{{ item.title }}{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-md-6">
    <img src="{{ item.image.url }}" alt="{{ item.title }}" class="img-fluid rounded">
  </div>
  <div class="col-md-6">
    <h1 class="h3">{{ item.title }}</h1>
    <p>{{ item.description }}</p>
    <p class="text-muted">Address: {{ item.address }}</p>
    <p>Starting price: <strong>{{ item.starting_price }}</strong></p>
    <p>Highest bid: <strong id="highest-amount">{% if item.highest_bid %}{{ item.highest_bid.amount }}{% else %}-{% endif %}</strong></p>
    <p>Participants: {{ item.participants_count }}{% if item.seat_limit %} / {{ item.seat_limit }} seats{% endif %}</p>
    <p>Ends at: {{ item.ends_at }}</p>

    {% if user.is_authenticated %}
      {% if participant and participant.is_booked %}
        <div class="alert alert-success py-2">
          Seat booked. Code: <strong>{{ participant.booking_code }}</strong>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-2">
          <a href="/items/{{ item.pk }}/unbook/" class="btn btn-outline-warning btn-sm">Unbook seat</a>
          <div class="dropdown">
            <button class="btn btn-outline-danger btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Pay penalty ₹200</button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/penalty/pay/?provider=gpay">Google Pay / UPI</a></li>
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/penalty/pay/?provider=bank">Bank Transfer</a></li>
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/penalty/pay/?provider=crypto">Crypto</a></li>
            </ul>
          </div>
        </div>
      {% else %}
        <div class="mb-2 d-flex flex-wrap gap-2">
          <div class="dropdown">
            <button class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Book seat ₹5</button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/book/?provider=gpay">Google Pay / UPI</a></li>
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/book/?provider=bank">Bank Transfer</a></li>
              <li><a class="dropdown-item" href="/items/{{ item.pk }}/book/?provider=crypto">Crypto</a></li>
            </ul>
          </div>
        </div>
      {% endif %}

      {% if item.owner_id != user.id %}
      <form action="/items/{{ item.pk }}/bid/" method="post" class="row gy-2 gx-2 align-items-center">
        {% csrf_token %}
        <div class="col-auto">
          <input type="number" step="0.01" min="0" name="amount" class="form-control" placeholder="Your bid" required>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary">Place bid</button>
        </div>
      </form>
      {% else %}
      <div class="alert alert-info py-2 mt-2">Owners cannot place bids.</div>
      {% endif %}

      {% if item.buy_now_price and item.owner_id != user.id %}
      <div class="mt-3">
        <div class="dropdown">
          <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Buy now for {{ item.buy_now_price }}</button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/items/{{ item.pk }}/buy/?provider=gpay">Google Pay / UPI</a></li>
            <li><a class="dropdown-item" href="/items/{{ item.pk }}/buy/?provider=bank">Bank Transfer</a></li>
            <li><a class="dropdown-item" href="/items/{{ item.pk }}/buy/?provider=crypto">Crypto</a></li>
          </ul>
        </div>
      </div>
      {% endif %}

      {% if item.owner_id == user.id %}
      <div class="mt-3 d-flex flex-column gap-2">
        <div class="d-flex gap-2">
          <a href="/items/{{ item.pk }}/preview/start/" class="btn btn-outline-info btn-sm">Start 10-min Preview</a>
          {% if not item.call_started_at %}
          <a href="/items/{{ item.pk }}/call/start/" class="btn btn-outline-light btn-sm">Start Video Call</a>
          {% else %}
          <a href="/items/{{ item.pk }}/call/" class="btn btn-outline-light btn-sm">Enter Call Room</a>
          {% endif %}
          <a href="/items/{{ item.pk }}/settle/" class="btn btn-outline-light btn-sm">Settle Auction</a>
        </div>
        <form action="/items/{{ item.pk }}/meet/" method="post" class="d-flex gap-2 align-items-center">
          {% csrf_token %}
          <input type="url" name="meet_url" class="form-control form-control-sm" placeholder="https://meet.google.com/xxx-xxxx-xxx" value="{{ item.meet_url }}">
          <button class="btn btn-outline-success btn-sm">Save Meet link</button>
          {% if item.meet_url %}
            <a href="{{ item.meet_url }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm">Open Meet</a>
          {% endif %}
        </form>
      </div>
      {% endif %}
    {% else %}
      <div class="alert alert-warning">Please <a href="/login/">login</a> to bid or buy.</div>
    {% endif %}
  </div>
</div>

<hr>
<h2 class="h5">Bids</h2>
<div id="live-bids">
  <ul class="list-group" id="bids-list">
    {% for bid in bids %}
      <li class="list-group-item d-flex justify-content-between">
        <span>{{ bid.bidder.username }}</span>
        <span>{{ bid.amount }}{% if not bid.is_active %} <span class="text-muted">(inactive)</span>{% endif %}</span>
        <span class="text-muted">{{ bid.created_at|date:'Y-m-d H:i:s' }}</span>
      </li>
    {% empty %}
      <li class="list-group-item">No bids yet.</li>
    {% endfor %}
  </ul>
  <div class="small text-muted mt-1">Auto-refreshing…</div>
  <script>
  (function(){
    function renderBids(data){
      var el = document.getElementById('bids-list');
      if (!el) return;
      if (!data.bids || !data.bids.length){
        el.innerHTML = '<li class="list-group-item">No bids yet.</li>';
        var hi = document.getElementById('highest-amount');
        if (hi) hi.textContent = '-';
        return;
      }
      el.innerHTML = data.bids.map(function(b){
        var inactive = b.is_active ? '' : ' <span class="text-muted">(inactive)</span>';
        var ts = new Date(b.created_at).toLocaleString();
        return '<li class="list-group-item d-flex justify-content-between">'
          + '<span>' + b['bidder__username'] + '</span>'
          + '<span>' + b.amount + inactive + '</span>'
          + '<span class="text-muted">' + ts + '</span>'
          + '</li>';
      }).join('');
      // Update header highest amount to top active bid
      var hi = document.getElementById('highest-amount');
      if (hi) {
        var top = data.bids.find(function(b){ return b.is_active; }) || data.bids[0];
        hi.textContent = top ? top.amount : '-';
      }
    }
    function tick(){
      fetch('/items/{{ item.pk }}/bids.json').then(function(r){ return r.json(); }).then(renderBids).catch(function(){});
    }
    setInterval(tick, 4000);
  })();
  </script>
  </div>

<div class="mt-3 small text-muted">
  <strong>Rules:</strong>
  <ul>
    <li>Sab bids sabko dikhengi: kisne, kab (exact time), aur kitni rakam.</li>
    <li>Minimum bid: Base price se zyada hi bid lagegi. Kam hui to reject.</li>
    <li>Bid se pehle wallet recharge zaroori. Balance kam hua to bid place nahi hogi.</li>
    <li>Winner decide hote hi amount auto-deduct hoga. Nahi jeete to paise safe.</li>
  </ul>
  Optional: Bank linking available; jeetne par direct bank se deduction ho sakta hai.
  <a href="/wallet/">Wallet</a>
  |
  <a href="/history/">History</a>
</div>

<hr>
<h2 class="h6">Join with code</h2>
<form action="/join/" method="post" class="row g-2">
  {% csrf_token %}
  <input type="hidden" name="item_id" value="{{ item.pk }}">
  <div class="col-auto"><input type="text" name="code" class="form-control" placeholder="CODE" required></div>
  <div class="col-auto"><button class="btn btn-outline-primary btn-sm">Verify Code</button></div>
  {% if has_verified_code %}
    <div class="col-12 small text-success">Code verified for this session.</div>
  {% endif %}
  {% if participant and participant.is_booked and not participant.unbooked_at and not has_verified_code %}
    <div class="col-12 small text-muted">Enter your unique code to enable call join.</div>
  {% endif %}
</form>

{% if user.is_authenticated and item.call_started_at %}
<div class="mt-3">
  {% if item.owner_id == user.id %}
    {% if item.meet_url %}
      <a href="{{ item.meet_url }}" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm">Enter Google Meet</a>
    {% else %}
      <span class="text-warning small">Set a Google Meet link above.</span>
    {% endif %}
  {% elif participant and participant.is_booked and not participant.unbooked_at and has_verified_code %}
    {% if item.meet_url %}
      <a href="{{ item.meet_url }}" target="_blank" rel="noopener" class="btn btn-outline-light btn-sm">Join Google Meet</a>
    {% else %}
      <span class="text-muted small">Waiting for seller to provide Google Meet link.</span>
    {% endif %}
  {% else %}
    <div class="alert alert-info py-2">Seat booking and code verification required to join the call.</div>
  {% endif %}
  <p class="text-muted small mt-2">Only the seller can start the call. Booked users can join.</p>
  </div>
{% endif %}

<script>
  // Presence ping every 10s if authenticated
  {% if user.is_authenticated %}
  setInterval(() => {
    fetch('/items/{{ item.pk }}/presence/');
  }, 10000);
  {% endif %}
</script>
{% endblock %}
