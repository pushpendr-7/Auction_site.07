{% extends 'auctions/base.html' %}
{% block title %}{{ item.title }}{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-md-6">
    <img src="{{ item.image.url }}" alt="{{ item.title }}" class="img-fluid rounded">
  </div>
  <div class="col-md-6">
    <h1 class="h3">{{ item.title }}</h1>
    <p>{{ item.description }}</p>
    <p class="text-muted">Address: {{ item.address }}</p>
    <p>Starting price: <strong>{{ item.starting_price }}</strong></p>
    <p>Highest bid: <strong>{% if item.highest_bid %}{{ item.highest_bid.amount }}{% else %}-{% endif %}</strong></p>
    <p>Participants: {{ item.participants_count }}{% if item.seat_limit %} / {{ item.seat_limit }} seats{% endif %}</p>
    <p>Ends at: {{ item.ends_at }}</p>

    {% if user.is_authenticated %}
      {% if participant and participant.is_booked %}
        <div class="alert alert-success py-2">
          Seat booked. Code: <strong>{{ participant.booking_code }}</strong>
        </div>
        <div class="d-flex gap-2 mb-2">
          <a href="/items/{{ item.pk }}/unbook/" class="btn btn-outline-warning btn-sm">Unbook seat</a>
          <a href="/items/{{ item.pk }}/penalty/pay/" class="btn btn-outline-danger btn-sm">Pay penalty ₹200</a>
        </div>
      {% else %}
        <div class="mb-2">
          <a href="/items/{{ item.pk }}/book/" class="btn btn-outline-success btn-sm">Book seat ₹5</a>
        </div>
      {% endif %}

      <form action="/items/{{ item.pk }}/bid/" method="post" class="row gy-2 gx-2 align-items-center">
        {% csrf_token %}
        <div class="col-auto">
          <input type="number" step="0.01" min="0" name="amount" class="form-control" placeholder="Your bid" required>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary">Place bid</button>
        </div>
      </form>

      {% if item.buy_now_price %}
      <div class="mt-3">
        <a href="/items/{{ item.pk }}/buy/" class="btn btn-success">Buy now for {{ item.buy_now_price }}</a>
      </div>
      {% endif %}

      {% if item.owner_id == user.id %}
      <div class="mt-3 d-flex gap-2">
        <a href="/items/{{ item.pk }}/preview/start/" class="btn btn-outline-info btn-sm">Start 10-min Preview</a>
        {% if not item.call_started_at %}
        <a href="/items/{{ item.pk }}/call/start/" class="btn btn-outline-light btn-sm">Start Video Call</a>
        {% else %}
        <a href="/items/{{ item.pk }}/call/" class="btn btn-outline-light btn-sm">Enter Call Room</a>
        {% endif %}
        <a href="/items/{{ item.pk }}/settle/" class="btn btn-outline-light btn-sm">Settle Auction</a>
      </div>
      {% endif %}
    {% else %}
      <div class="alert alert-warning">Please <a href="/login/">login</a> to bid or buy.</div>
    {% endif %}
  </div>
</div>

<hr>
<h2 class="h5">Bids</h2>
<ul class="list-group">
  {% for bid in bids %}
    <li class="list-group-item d-flex justify-content-between">
      <span>{{ bid.bidder.username }}</span>
      <span>{{ bid.amount }}</span>
      <span class="text-muted">{{ bid.created_at }}</span>
    </li>
  {% empty %}
    <li class="list-group-item">No bids yet.</li>
  {% endfor %}
</ul>

<hr>
<h2 class="h6">Join with code</h2>
<form action="/join/" method="post" class="row g-2">
  {% csrf_token %}
  <input type="hidden" name="item_id" value="{{ item.pk }}">
  <div class="col-auto"><input type="text" name="code" class="form-control" placeholder="CODE" required></div>
  <div class="col-auto"><button class="btn btn-outline-primary btn-sm">Verify Code</button></div>
  {% if has_verified_code %}
    <div class="col-12 small text-success">Code verified for this session.</div>
  {% endif %}
  {% if participant and participant.is_booked and not participant.unbooked_at and not has_verified_code %}
    <div class="col-12 small text-muted">Enter your unique code to enable call join.</div>
  {% endif %}
</form>

{% if user.is_authenticated and item.call_started_at %}
<div class="mt-3">
  {% if item.owner_id == user.id %}
    <a href="/items/{{ item.pk }}/call/" class="btn btn-outline-light btn-sm">Enter Call Room</a>
  {% elif participant and participant.is_booked and not participant.unbooked_at and has_verified_code %}
    <a href="/items/{{ item.pk }}/call/" class="btn btn-outline-light btn-sm">Join Video Call</a>
  {% else %}
    <div class="alert alert-info py-2">Seat booking and code verification required to join the call.</div>
  {% endif %}
  <p class="text-muted small mt-2">Only the seller can start the call. Booked users can join.</p>
  </div>
{% endif %}

<script>
  // Presence ping every 10s if authenticated
  {% if user.is_authenticated %}
  setInterval(() => {
    fetch('/items/{{ item.pk }}/presence/');
  }, 10000);
  {% endif %}
</script>
{% endblock %}
